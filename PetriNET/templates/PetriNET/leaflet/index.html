{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<!-- Иконки -->
<link href="{% static 'fontawesomefree/css/fontawesome.css' %}" rel="stylesheet" type="text/css">
<link href="{% static 'fontawesomefree/css/brands.css' %}" rel="stylesheet" type="text/css">
<link href="{% static 'fontawesomefree/css/solid.css' %}" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
{% endblock %}
{% block js %}
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
{{ citys|json_script:"citys_json" }}
{% endblock %}

{% block body %}
<div id="map">
</div>
<div id="left-panel" class="container d-flex align-items-center">
    <div id="left-function-panel" class="row shadow-sm">
        <div class="dropdown mb-3">
            <select class="selectpicker" title="Выберите город" data-style="btn-primary" data-live-search="true" id="dropdownMenuButton" onchange="ChangeCityOnSelect(this)">
                {% if citys %}
                {% for city in citys %}
                <option value="{{city.id}}">{{city.name}}</option>
                {% endfor %}
                {% else %}
                <option value="0">Добавить</option>
                {% endif %}
            </select>
        </div>
        <div class="card bg-transparent border-primary w-100 mb-3">
            <div class="card-header bg-light">
                Остановки
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="BusStopName" placeholder="Название остановки"
                        aria-label="Название остановки" aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button id="BusStopAdd" class="btn btn-primary" type="button" title="Двойной клик по карте, удержание для переноса">+</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card bg-transparent border-primary w-100 mb-3">
            <div class="card-header bg-light">
                Маршруты
            </div>
            <div class="card-body text-center">
                    <div class="btn-group d-flex mb-3">
                        <button class="btn btn-primary w-100" id="RouteAll" type="button" onclick="ShowAllRoutes()">Показать
                            все</button>
                        <button class="btn btn-primary partition w-100" id="RouteOne" type="button">Выбрать один</button>
                        <button id="RouteAdd" class="btn btn-primary partition" type="button">+</button>
                    </div>
            </div>
        </div>
        <div class="card bg-transparent border-primary w-100 mb-3">
            <div class="card-header bg-light">
                Расчёт нагрузки
            </div>
            <div class="card-body text-center">
                <input id="FilePetri" type="file" style="display: none;" onchange="PetriFileProcess(this.files)" onclick="this.value = null;" />
                <button class="btn btn-primary mb-3 btn-block" id="FilePetriButton" type="button">Из <a
                        href="{% static 'petri_example.json' %}" title="Скачать пример файла" download=""
                        class="text-white" onclick="event.stopPropagation();">файла</a></button>
                <div class="btn-group d-flex mb-3">
                    <div type="button" class="btn btn-primary bd-highlight w-100" onclick="RoutesChoose()">Выбрать
                        маршруты
                    </div>
                    <button type="button" class="btn btn-primary partition" onclick="DownloadDataToCalculate()"
                    title="Скачать сформированный файл"><i class="fas fa-floppy-disk"></i></button>
                    <div type="button" class="btn btn-danger bd-highlight partition" onclick="Reset()">Сброс</div>
                </div>
                <div type="button" class="btn btn-success bd-highlight mb-3 mr-3 btn-block" onclick="Сalculation()">
                    Расчёт
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Див нижней панели имитации работы онлайн -->
<div id="bottom-panel" class="container d-none justify-content-center align-items-center">
    <!-- d-flex -->
    <div id="bottom-function-panel" class="row shadow-sm">
        <div class="card border-primary w-100 mb-4">
            <div class="card-header bg-light">
                Имитация работы транспортной сети
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="end_simulation()">
                    <span aria-hidden="true">×</span>
                </button>    
            </div>
            <div class="card-body text-center">
                <div class="row">            
                    <div class="col">
                        <input type="range" class="form-range w-100" id="StepsImitation" min="1" step="1">
                    </div>
                </div>
                <div class="row">            
                    <div class="col small mb-2" style="text-align: left;">
                        Шаг
                    </div>
                    <div class="col small mb-2" id="StepNow">
                        50
                    </div>
                    <div class="col small mb-2" id="LenStep" style="text-align: right;">
                        100
                    </div>
                </div>
                <div class="row">
                    <div class="col" style="text-align: left;">
                        <div class="btn-group" role="group">
                            <!-- Ускорить -->
                            <button type="button" class="btn btn-primary" onclick="setSingleStep(0)"><i class="fas fa-angle-right"></i></button>
                            <button type="button" class="btn btn-primary" onclick="setSingleStep(10)"><i class="fas fa-angle-right"></i><i class="fas fa-angle-right"></i></button>
                            <button type="button" class="btn btn-primary" onclick="setSingleStep(50)"><i class="fas fa-angle-right"></i><i class="fas fa-angle-right"></i><i class="fas fa-angle-right"></i></button>
                            <div class="input-group-text" id="SingleStepTitle">1</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="btn-group" role="group">
                            <!-- Сброс -->
                            <button type="button" class="btn btn-primary" onclick="stopTimer(), setRangeValue(1)"><i class="fas fa-redo"></i></button>
                            <!-- Запуск -->
                            <button type="button" class="btn btn-success" onclick="playTimer()"><i class="fas fa-play"></i></button>
                            <!-- Пауза -->
                            <button type="button" class="btn btn-danger" onclick="stopTimer()"><i class="fas fa-pause"></i></button>
                        </div>
                    </div>
                    <div class="col" style="text-align: right;">
                        <!-- Скачать отчёт -->
                        <button class="btn btn-primary" type="button" onclick="DownloadReport()">Скачать отчёт <i class="fa-solid fa-download"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно отображения одного маршрута-->
<div class="modal fade" id="ChoiceRoute" tabindex="-1" aria-labelledby="ChoiceRouteTitle" style="display: none;"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ChoiceRouteTitle">Выберите маршрут</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно выбора маршрутов для расчёта-->
<div class="modal fade" id="ChoiceRouteForCalculate" tabindex="-1" aria-labelledby="ChoiceRouteTitle" style="display: none;"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ChoiceRouteTitle">Выберите маршруты для расчёта</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно отображения результатов расчёта-->
<div class="modal fade" id="AnalysisOfCalculationResults" tabindex="-1"
    aria-labelledby="AnalysisOfCalculationResultsTitle" style="display: none;" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ChoiceRouteTitle">Результат расчёта</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <button class="btn btn-primary" type="button" onclick="DownloadReport()">Скачать отчёт <i class="fa-solid fa-download"></i></button>
                <button class="btn btn-primary" data-dismiss="modal" type="button" onclick="simulation()">Имитировать работу онлайн</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block endjs %}
<script>
    let CurrentCity
    let Routes = []

    // Переменные для добавления данных
    let ActionOnClick = ""
    let TempMarker
    let TempRoute
    let TempRouteList = []

    let EI = "Людей"

    // Переменные для расчёта
    let RoutesForCalculate = []
    let BSPassengersDirections = {}

    var map = L.map('map', { attributionControl: false }).setView([51.7727, 55.0988], 4);
    L.control.attribution({ prefix: 'Маршрутно-транспортные сети | {% if user.is_superuser %}<a href="{% url "admin:index" %}">Админ панель</a>{% else %}<a href="{% url "accounts:logout" %}">Выйти</a>{% endif %}' }).addTo(map);

    // Карты
    var lyrOSM = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var lyrEsriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    // Поверхности объектов
    let BusStops = L.layerGroup().addTo(map);
    let CitysLayer = L.markerClusterGroup().addTo(map);
    let RouteLayer = L.layerGroup().addTo(map);

    // Обработчик изменения масштаба карты
    map.on('zoomend', function() {
        var currentZoom = map.getZoom();
        // Управление видимостью маркеров в зависимости от уровня зума
        if (currentZoom < 15 && BusStops.getLayers().length >= 1000) {
            map.removeLayer(BusStops);
        } else {
            map.addLayer(BusStops);
        }
    });

    // Настройки карты в правом окошке
    let Maps = {
        "OpenStreetMap": lyrOSM,
        "ESRI World Imagery": lyrEsriImagery
    };
    let hide_view_groups = {
        "Города": CitysLayer,
        "Остановки": BusStops,
        "Маршруты": RouteLayer,
    }
    L.control.layers(Maps, hide_view_groups, { collapsed: false }).addTo(map);

    // Разбор данных городов
    let citys = JSON.parse(document.getElementById('citys_json').textContent)
    citys.forEach(city => {
        var CityIcon = L.icon({
            iconUrl: '{% static 'city_icon.png' %}',
            iconSize: [26, 26], // Размеры иконки
            iconAnchor: [13, 30], // Точка, которая соответствует "ноге" маркера
            popupAnchor: [1, -25] // Точка относительно иконки, где будет отображаться всплывающее окно
        });
        let city_style = {
            icon: CityIcon,
            alt: city.name,
        };
        CitysLayer.addLayer(L.marker([city.latitude, city.longitude], city_style)
            .bindPopup(`<a href="#" onclick="ChoiceCity(${city.id})">${city.name}</a>`).on('dblclick', (event) => {
                ChoiceCity(city.id)
            }));
    });

    // Получение ключа сервера
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Функция проверки выбора города
    function CityExists() {
        if (CurrentCity) {
            return true
        }
        else {
            alert('Выберите город');
            return false
        }
    }

    // Функция проверки заполнения данных для расчёта
    function CheckDataToCalculateExists() {
        if (RoutesForCalculate.length == 0) {
            alert('Не выбраны маршруты для расчёта!');
            return false
        }
        if (Object.keys(BSPassengersDirections).length == 0) {
            alert('Отсутствуют пассажиры на остановках!');
            return false
        }
        return true
    }

    // Кнопка добавления остановки
    $("#BusStopAdd").click(function () {
        $(this).removeClass('btn-danger btn-success').addClass('btn-primary');
        if (!CityExists()) {
            return
        }
        let BusStopName = $("#BusStopName").val()
        if (BusStopName) {
            if (ActionOnClick == 'AddTempMarker' && typeof TempMarker !== "undefined" && TempMarker !== null) {
                $(this).removeClass('btn-danger btn-success').addClass('btn-primary');
                $(this).text('+');
                const csrftoken = getCookie('csrftoken');
                $.ajax({
                    url: '{% url "PetriNET:create_bs" %}',
                    method: 'post',
                    dataType: 'html',
                    headers: { 'X-CSRFToken': csrftoken },
                    data: {
                        name: BusStopName,
                        lat: TempMarker.getLatLng().lat,
                        lng: TempMarker.getLatLng().lng,
                        city_id: CurrentCity.id,
                    },
                    success: function (data) {
                        if (JSON.parse(data).error == 0) {
                            latlng = [TempMarker.getLatLng().lat, TempMarker.getLatLng().lng]
                            AddBS(latlng, JSON.parse(data).BusStop.id, BusStopName);
                            CloseAllAction();
                        }
                        else {
                            CloseAllAction();
                            alert("Ошибка добавления остановки\nОтвет сервера: " + JSON.parse(data).error + ' ' + JSON.parse(data).error_message)
                        }
                    },
                    error: function (jqXHR, exception) {
                        CloseAllAction();
                        alert(`Ошибка сервера\nСтатус: ${jqXHR.status}\nИсключение: ${exception}`)
                    }
                });
                return
            };
            if (ActionOnClick == 'AddTempMarker') {
                CloseAllAction();
                return
            }
            $(this).removeClass('btn-success btn-primary').addClass('btn-danger');
            $(this).text('x');
            ActionOnClick = 'AddTempMarker'
        }
        else {
            alert('Введите название остановки!');
        }
    });

    function ClickOnBS(BS) {
        latlng = [BS.latlng.lat, BS.latlng.lng]
        if (ActionOnClick == 'AddTempRoute') {
            BS.target.closePopup();
            let include = -1
            TempRouteList.forEach((value, i) => {
                if (value[0] == latlng[0] && value[1] == latlng[1]) {
                    include = i
                }
            })
            if (include >= 0) {
                TempRouteList.splice(include, 1);
            }
            else {
                TempRouteList.push(latlng)
            }
            if (TempRouteList.length <= 1) {
                $("#RouteAdd").removeClass('btn-success btn-primary').addClass('btn-danger');
                $("#RouteAdd").text('x');
                if (TempRoute) {
                    TempRoute.remove()
                    TempRoute = null;
                }
            }
            if (TempRoute && TempRouteList.length <= 1) {
                TempRoute.remove()
                TempRoute = null;
            }
            if (TempRoute && TempRouteList.length > 1) {
                TempRoute.setLatLngs(TempRouteList);
            }
            if (TempRouteList.length > 1 && (typeof TempRoute == "undefined" || TempRoute == null)) {
                TempRoute = L.polyline(TempRouteList, {
                    // color: arrayRandElement(ListColor),
                    weight: 6,
                    fillOpacity: 0.2,
                }).addTo(map);
            }
            if (TempRouteList.length > 1) {
                $("#RouteAdd").removeClass('btn-danger btn-primary').addClass('btn-success');
                $("#RouteAdd").text('✓');
            }
        }
        else {
            SetDataToBSPopup()
        }
    }

    // Кнопка добавления маршрута
    $("#RouteAdd").click(function () {
        $(this).removeClass('btn-danger btn-success').addClass('btn-primary');
        if (!CityExists()) {
            return
        }
        if (ActionOnClick == 'AddTempRoute' && typeof TempRoute !== "undefined" && TempRoute !== null) {
            $(this).removeClass('btn-danger btn-success').addClass('btn-primary');
            $(this).text('+');
            const csrftoken = getCookie('csrftoken');
            $.ajax({
                url: '{% url "PetriNET:create_route" %}',
                method: 'post',
                dataType: 'html',
                headers: { 'X-CSRFToken': csrftoken },
                data: {
                    list_coord: JSON.stringify(TempRouteList),
                    name: "Изменить название маршрута",
                    city_id: CurrentCity.id,
                },
                success: function (data) {
                    if (JSON.parse(data).error == 0) {
                        CreateRoute(JSON.parse(data).Route.list_coord, JSON.parse(data).Route.id, JSON.parse(data).Route.name)
                        $("#RouteAll").click();
                    }
                    else {
                        alert("Ошибка добавления маршрута\nОтвет сервера: " + JSON.parse(data).error + ' ' + JSON.parse(data).error_message)
                    }
                },
                error: function (jqXHR, exception) {
                    alert(`Ошибка сервера\nСтатус: ${jqXHR.status}\nИсключение: ${exception}`)
                }
            })
            CloseAllAction();
            return
        };
        if (ActionOnClick == 'AddTempRoute') {
            CloseAllAction();
            return
        }
        RouteLayer.clearLayers();
        $(this).removeClass('btn-primary btn-success').addClass('btn-danger');
        $(this).text('x');
        ActionOnClick = 'AddTempRoute'
    });

    function ShowAllRoutes() {
        if (!CityExists()) {
            return
        }
        RouteLayer.clearLayers();
        Routes.forEach(route => {
            DrawRoute(route)
        })
    }

    // Отображение модального окна выбора маршрута
    $("#RouteOne").click(function () {
        if (!CityExists()) {
            return
        }
        let modal = $("#ChoiceRoute")
        let body = modal.find(".modal-body")
        if (Routes.length > 0) {
            body.html(`
            <div class="d-flex justify-content-center flex-wrap bd-highlight">
            `)
            Routes.forEach((route, index) => {
                body.append(`<div type="button" class="btn btn-primary bd-highlight mb-3 mr-3" onclick="ChoiceOneRoute(${route.id})">${index + 1}: ${route.name}</div>`)// <button type="button" class="btn btn-primary" onclick="ChoiceOneRoute(${route.id})">${route.name}</button></div>`)
            })
            body.append(`
            </div>
            `)
        }
        else {
            body.html('<p>Маршрутов нет</p>')
        }
        modal.modal('show')
    })

    // Отображение одного маршрута
    function ChoiceOneRoute(id) {
        if (!CityExists()) {
            return
        }
        route = Routes.find(route => route.id == id)
        if (route) {
            RouteLayer.clearLayers();
            DrawRoute(route);
            $("#ChoiceRoute").modal('hide');
        }
        else {
            alert("Маршрут не найден!")
        }
    }

    var canvasRenderer = L.canvas();

    // Добавление остановки в группу остановок на карту
    function AddBS(latlng, id, name) {
                var busStopIcon = L.icon({
            iconUrl: '{% static 'bus_icon.png' %}',
            iconSize: [14, 14], // Размеры иконки
            iconAnchor: [7, 7], // Точка, которая соответствует "ноге" маркера
            popupAnchor: [1, -20], // Точка относительно иконки, где будет отображаться всплывающее окно
            renderer: canvasRenderer
        });
        let popup = `<a href="{% url 'admin:index' %}PetriNET/busstop/${id}/change/"><p>${name} ID: ${id}</p></a>`
        popup += `
            <div class="BusStopPassengers">
                <input id="BSID" type="text" value="${id}" hidden>
                <div id="DirectionsSheet">
                    <div class="input-group d-flex flex-nowrap mb-1">
                        <div class="input-group-prepend">
                        <div class="input-group-text" id="btnGroupAddon">${EI}</div>
                        </div>
                        <input type="number" id="PWD" class="form-control" style="width: 220px;" placeholder="В случайное направление" aria-label="В случайное направление" aria-describedby="btnGroupAddon" min="0">
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-block mt-3" title="Добавить направление" onclick="AddDirection(this, ${id})">+</button>
            </div>
            `
        BusStops.addLayer(L.marker(latlng, { icon: busStopIcon, alt: "Остановка" }).bindPopup(popup).on('click', ClickOnBS))
    }

    // Добавление маршрута в список
    function CreateRoute(list_coord, id, name) {
        Routes.push({
            "list_coord": list_coord,
            "id": id,
            "name": name
        })
    }

    // Добавление маршрутов в группу маршрутов на карту
    function DrawRoute(route) {
        RouteLayer.addLayer(L.polyline(route.list_coord, {
            // color: arrayRandElement(ListColor),
            weight: 6,
            fillOpacity: 0.2,
        }).bindPopup(`<a href="{% url 'admin:index' %}PetriNET/route/${route.id}/change/"><p>${route.name}</p></a>`));
    }

    // Прекращение выполнений действий добавления
    function CloseAllAction() {
        if (TempRoute) {
            TempRoute.remove();
        }
        TempRoute = null;
        TempRouteList = [];
        ActionOnClick = "";
        $("#RouteAdd").removeClass('btn-danger btn-success').addClass('btn-primary');
        $("#RouteAdd").text('+');
        if (TempMarker) {
            TempMarker.remove();
        }
        TempMarker = null;
        ActionOnClick = "";
        $("#BusStopName").val('');
        $("#BusStopAdd").removeClass('btn-danger btn-success').addClass('btn-primary');
        $("#BusStopAdd").text('+');
    }

    function UpdateCityData() {
        if (!CurrentCity) {
                return
            }
        BusStops.clearLayers();
        RouteLayer.clearLayers();
        Routes = [];
        const csrftoken = getCookie('csrftoken');
        $.ajax({
            url: '{% url "PetriNET:get_city_data" %}',
            method: 'get',
            dataType: 'html',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                city_id: CurrentCity.id,
            },
            success: function (data) {
                JSON.parse(data).BSList.forEach(BS => {
                    AddBS([BS.latitude, BS.longitude], BS.id, BS.name);
                });
                JSON.parse(data).RouteList.forEach(Route => {
                    CreateRoute(Route.list_coord, Route.id, Route.name)
                });
                $("#RouteAll").click();
            }
        });
    }

    // Выбор города, запрос к бд для получения данных города и его маршрутов
    function ChoiceCity(id) {
        let CityID = id
        let City = citys.find(el => el.id == CityID)
        let CityCircle = CitysLayer.getLayers().find(layer => layer.getLatLng().lat == City.latitude && layer.getLatLng().lng == City.longitude)
        CityCircle.closePopup();
        map.setView([City.latitude, City.longitude], 12);
        if (CurrentCity !== City) {
            CloseAllAction();
            if (CurrentCity) {
                Reset()
            }
            CurrentCity = City;
            $('#dropdownMenuButton').val(id);
            $('#dropdownMenuButton').selectpicker('refresh')
            UpdateCityData()
        }
    }

    function ChangeCityOnSelect(selectObject) {
        var value = selectObject.value;
        if (value == "0") {
            const link = document.createElement('a');
            url = "{% url 'admin:index' %}"
            link.href = url;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        if (value) {
            ChoiceCity(value)
        }
    }

    // Обработка двойного клика на карте
    map.on('dblclick', (event) => {
        if (ActionOnClick == 'AddTempMarker') {
            if (TempMarker) {
                TempMarker.remove()
            }
            TempMarker = L.marker([event.latlng.lat, event.latlng.lng], { opacity: 0.5, draggable: true }).addTo(map).on('click', (event) => {
                CloseAllAction();
            })
            $("#BusStopAdd").removeClass('btn-danger btn-primary').addClass('btn-success');
            $("#BusStopAdd").text('✓');
        }
    })

    // Обработка кнопки Из файла
    $('#FilePetriButton').on('click', function () {
        if (!CityExists()) {
            return
        }
        $('#FilePetri').trigger('click');
    });

    // Функция заполнения окна Выбрать маршруты
    function SetChoiceRouteForCalculate() {
        let modal = $("#ChoiceRouteForCalculate")
        let body = modal.find(".modal-body")
        if (body.html().trim() !== '') {}
        else if (Routes.length > 0) {
            body.html(`
            <div class="d-flex justify-content-center flex-wrap bd-highlight">
            `)
            Routes.forEach((route, index) => {
                body.append(`
                    <button id="RouteCheckbox${route.id}" type="button" class="btn btn-primary bd-highlight mb-3 mr-3" data-toggle="button" aria-pressed="false"
                    onclick="RouteCheck(${route.id});">
                    ${index + 1}: ${route.name}
                    </button>
                `)
            })
            body.append(`
            </div>
            `)
        }
        else {
            body.html('<p>Маршрутов нет</p>')
        }
        // Отрисовать только нужные маршруты
        DrawRoutsForCalculate()
    }

    // Обработка кнопки Выбрать маршруты
    function RoutesChoose() {
        if (!CityExists()) {
            return
        }
        if (RoutesForCalculate.length > 0) {
            RouteLayer.clearLayers();
            RoutesForCalculate.forEach((route, index) => {
                DrawRoute(route);
            })
        }
        let modal = $("#ChoiceRouteForCalculate")
        let body = modal.find(".modal-body")
        SetChoiceRouteForCalculate()
        modal.modal('show')
    }


    //////
    // Функции работы с заполнением кол-ва пассажиров
    //////

    
    function GetPopudBS(id) {
        BSPopup = null
        $(".BusStopPassengers").each(function() {
            var popupContent = $(this)
            var BSIDValue = popupContent.find("#BSID").val();
            if (id && BSIDValue && BSIDValue == id) {
                BSPopup = this
            }
            else if (!id) {
                BSPopup = this
            }
        });
        // if (BSPopup) {
        //     return BSPopup
        // }
        // else if (id) {
        //     BusStops.eachLayer(function(layer) {
        //         if (layer.getPopup) {
        //             var popup = layer.getPopup();
        //             var popupContent = $(popup.getContent()); 
        //             if (popupContent.find('#BSID').length > 0) {
        //                 var BSIDValue = popupContent.find('#BSID').val();
        //                 if (BSIDValue && BSIDValue == id) {
        //                     BSPopup = popup.getContent()
        //                     return BSPopup
        //                 }
        //             }
        //         }
        //     });
        // }
        return BSPopup
    }

    function AddDirection(button, id) {
        let parentDiv = $(button).closest('.BusStopPassengers');
        let DirectionsSheetDiv = $(parentDiv).find('#DirectionsSheet')
        let LastDiv = DirectionsSheetDiv.find('.input-group').last().attr("id")
        if (!LastDiv) {
            LastDiv = 1
        }
        else {
            LastDiv = parseInt(LastDiv) + 1
        }
        DirectionsSheetDiv.append(
        `                    
        <div class="input-group mb-1" id="${LastDiv}">
            <input type="number" id="BusStopID${LastDiv}" class="form-control" placeholder="ID Остановки" aria-label="ID Остановки" min="0">
            <input type="number" id="PassengersCount${LastDiv}" class="form-control" placeholder="Кол-во людей" aria-label="Кол-во людей" min="0">
        </div>
        `
        )
        let BSIDValue = $(parentDiv).find('#BSID').val();
    }

    $(document).on('change', '.leaflet-popup-content input[type=number]', function() {
        let parentDiv = $(this).closest('.BusStopPassengers');
        let BSID = $(parentDiv).find('#BSID').val();
        let key = $(this).attr('id');
        let data = $(this).val();
        data = data.replace(/[+-]/g, '')
        if (!BSPassengersDirections[BSID]) {
            BSPassengersDirections[BSID] = {
                "Directions": {},
            }
        }
        if (key.includes("BusStopID") || key.includes("PassengersCount")) {
            if (key.includes("BusStopID")) {
                base_str = "BusStopID"
            } else {
                base_str = "PassengersCount"
            }
            DirectionID = key.slice(base_str.length)
            if (!BSPassengersDirections[BSID]["Directions"][DirectionID]) {
                BSPassengersDirections[BSID]["Directions"][DirectionID] = {}
            }
            BSPassengersDirections[BSID]["Directions"][DirectionID][key] = data
        }
        else {
            BSPassengersDirections[BSID][key] = data
        }
    });

    function SetDataToBSPopup() {
        BSPopup = GetPopudBS()
        let DirectionsSheetDiv = $(BSPopup).find('#DirectionsSheet')
        let BSID = $(BSPopup).find('#BSID').val();
        $('.leaflet-popup-content input[type=number]').each(function() {
            var key = $(this).attr('id');
            if (BSPassengersDirections[BSID] && BSPassengersDirections[BSID][key]) {
                $(this).val(BSPassengersDirections[BSID][key]);
            }
        });
        if (BSPassengersDirections[BSID] && BSPassengersDirections[BSID]["Directions"]) {
            for (const [key, value] of Object.entries(BSPassengersDirections[BSID]["Directions"])) {
                var AppendDiv = `                    
                <div class="input-group mb-1" id="${key}">
                    <input type="number" id="BusStopID${key}" class="form-control" placeholder="ID Остановки" aria-label="ID Остановки" min="0">
                    <input type="number" id="PassengersCount${key}" class="form-control" placeholder="Кол-во людей" aria-label="Кол-во людей" min="0">
                </div>
                `
                DirectionsSheetDiv.append(AppendDiv)
                for (const [InputID, InputValue] of Object.entries(value)) {
                    DirectionsSheetDiv.find(`#${InputID}`).val(InputValue)
                }
            }
        }
    }


    //////
    //
    //////


    // Формирование данных для сохранения в файл / отправки на сервер
    function CreateDataToCalculate() {
        if (!CheckDataToCalculateExists()) {
            return null
        }
        DataToCalculate = {
            "routes": RoutesForCalculate.map(({ id, name }) => ({ id, name })),
            "busstops": BSPassengersDirections,
            "city_id": CurrentCity.id,
        }
        return DataToCalculate
    }

    // Функция Скачивания данных для расчёта
    function DownloadDataToCalculate() {
        if (!CityExists()) {
            return
        }
        DataToCalculate = CreateDataToCalculate()
        if (DataToCalculate == null) {
            return
        }
        // Преобразование данных в строку JSON
        const dataStr = JSON.stringify(DataToCalculate);
        // Создание Blob объекта с типом данных JSON
        const blob = new Blob([dataStr], { type: "application/json" });
        // Создание URL для Blob объекта
        const url = URL.createObjectURL(blob);

        // Создание временной ссылки для скачивания
        const link = document.createElement('a');
        Data = new Date();
        Data.setMilliseconds(0)
        link.download = `DataToCalculate_${Data.toLocaleDateString()}_${Data.toLocaleTimeString()}.json`; // Имя файла для скачивания
        link.href = url;
        link.style.display = 'none'; // Скрытие ссылки

        // Добавление ссылки к документу и её активация для начала скачивания
        document.body.appendChild(link);
        link.click();

        // Очистка ресурсов после скачивания
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    }

    // Функция обработки нажатия кнопок маршрутов
    function RouteCheck(id) {
        btn = $('#RouteCheckbox' + id)
        route = Routes.find(route => route.id == id)
        if (!route) {
            alert("Маршрут не найден!")
            return
        }
        if (!btn.hasClass('active')) {
            RoutesForCalculate.push(route)
        }
        else {
            let include = -1
            RoutesForCalculate.forEach((item, index) => {
                if (item.id == id) {
                    include = index
                }
            })
            if (include >= 0) {
                RoutesForCalculate.splice(include, 1);
            }
        }
        DrawRoutsForCalculate()
    }

    function DrawRoutsForCalculate() {
        if (RoutesForCalculate.length > 0) {
            RouteLayer.clearLayers();
            RoutesForCalculate.forEach((route, index) => {
                DrawRoute(route);
            })
        }
        else {
            ShowAllRoutes()
        }
    }

    // Обработка кнопки Сброс
    function Reset() {
        // Сбросить выбор маршрутов
        let modal = $("#ChoiceRouteForCalculate")
        let body = modal.find(".modal-body")
        body.html('')
        CloseAllAction()
        RoutesForCalculate = []
        BSPassengersDirections = {}
        map.closePopup()
        ShowAllRoutes()
    }


    // Обработка кнопки Расчёт
    function Сalculation() {
        if (!CityExists()) {
            return
        }
        DataToCalculate = CreateDataToCalculate()
        if (DataToCalculate == null) {
            return
        }
        const csrftoken = getCookie('csrftoken');
        $.ajax({
            url: '{% url "PetriNET:load_calculation" %}',
            method: 'post',
            dataType: 'html',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                "DataToCalculate": JSON.stringify(DataToCalculate),
            },
            success: function (data) {
                data_from_server = JSON.parse(data)
                analysis_of_calculation_result(data_from_server)
            },
            error: function (jqXHR, exception) {
                alert(`Ошибка сервера\nСтатус: ${jqXHR.status}\nИсключение: ${exception}`)
            }
        });
    }

    // Разбор файла пользователя
    function PetriFileProcess(files) {
        if (files.length > 0) {
            let file = files[0];
            if (file.type == 'application/json') {
                Reset()
                let reader = new FileReader();
                reader.onload = function (e) {
                    let DataToCalculate = JSON.parse(e.target.result)
                    try {
                        if (DataToCalculate.city_id != CurrentCity.id) {
                            throw `Не правильно выбран город. Нужно: ${DataToCalculate.city_id}, ваш: ${CurrentCity.id}`;
                        }
                        BSPassengersDirections = DataToCalculate.busstops
                        RoutesForCalculate = Routes.filter(route =>
                            DataToCalculate.routes.some(rout => rout.id == route.id)
                        );
                        SetChoiceRouteForCalculate()
                        RoutesForCalculate.forEach((route, index) => {
                            $(`#RouteCheckbox${route.id}`).addClass("active").attr('aria-pressed="true"')
                        })
                    } catch (e) {
                        Reset()
                        alert(e)
                    }
                };
                reader.readAsText(file);
            }
            $("#FilePetri").val(null);
        }
    }

    // Данные для имитации работы онлайн
    let simulation_data
    let bus_markers = [] // Список автобусов
    let bus_stop_markers = [] // Список остановок
    let animation_list = [] // Список запущенных анимаций

    function stop_all_animation() {
        animation_list.forEach(animation => {
            animation.stop()
        })
        animation_list = []
        bus_markers.forEach(bus => {
            bus.marker.setLatLng([bus.lat, bus.lng])
        })
    }

    function clear_bus_markers() {
        bus_markers.forEach(bus => {
            bus.marker.remove()
        })
        bus_markers = []
    }

    function clear_bus_stop_markers() {
        bus_stop_markers.forEach(bus_stop => {
            if (bus_stop.marker) {
                bus_stop.marker.remove()
            }
        })
        bus_stop_markers = []
    }

    function clear_data_for_simulation() {
        // Остановить таймер
        stopTimer()
        stop_all_animation()
        clear_bus_markers()
        clear_bus_stop_markers()
    }

    // Функция разбора результатов расчёта
    function analysis_of_calculation_result(data_from_server) {
        if (data_from_server.error == 0) {
            simulation_data = data_from_server
            let modal = $("#AnalysisOfCalculationResults");
            modal.modal('show')
        }
        else {
            alert("Ошибка расчёта\nОтвет сервера: " + data_from_server.error + ' ' + data_from_server.error_message)
        }
    }

    // Глобальные переменные для имитации работы
    let step_speed = 800
    let timer = null

    // Имитировать работу онлайн
    function simulation() {
        if (!simulation_data) {
            return
        }
        DrawRoutsForCalculate()
        // Скрыть левую панель
        $("#left-panel").removeClass("d-flex");
        $("#left-panel").addClass("d-none");
        // Показать нижнюю
        $("#bottom-panel").removeClass("d-none");
        // Очистить карту от старых ОП
        BusStops.clearLayers();
        // Указать у StepsImitation количество step и max
        let maxSteps = simulation_data.calculate.length; // Установите здесь желаемое количество шагов
        $("#StepsImitation").attr("max", maxSteps);
        $("#LenStep").text(maxSteps);
        setRangeValue(1)
        setSingleStep(0)
    }

    // Функция получения часов из секунд
    function formatTime(seconds) {
        var hours = Math.floor(seconds / 3600); // Получаем количество часов
        var minutes = Math.floor((seconds % 3600) / 60); // Получаем количество минут
        var seconds = seconds % 60; // Получаем оставшиеся секунды

        // Добавляем ведущие нули, если необходимо
        var hoursFormatted = hours.toString().padStart(2, '0');
        var minutesFormatted = minutes.toString().padStart(2, '0');
        var secondsFormatted = seconds.toString().padStart(2, '0');

        // Собираем итоговую строку времени
        return '(' + hoursFormatted + ':' + minutesFormatted + ':' + secondsFormatted + ')';
    }


    function SetDataToBPopup(BMarker) {
        var BPopup
        var BIDValue
        var BRIDValue
            $(".BPassengers").each(function() {
                var popupContent = $(this)
                BIDValue = popupContent.find("#BID").val();
                BRIDValue = popupContent.find("#BRID").val();
                BPopup = this
            });
        let PassengersDiv = $(BPopup).find('#Passengers')
        PassengersDiv.html('')

        $('#Passengers').each(function() {
            if (BRIDValue) {
                // Автобус
                bus = bus_markers.find(bus => bus.bus_id == BIDValue && bus.route_id == BRIDValue)
                bus.passengers.forEach(passenger => {
                    var AppendDiv = `
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon3">${passenger.name}</span>
                        </div>
                        <span class="input-group-text" id="basic-addon3" onmouseover="ShowBS(${passenger.start})" onmouseout="HiddenShowBS()">${passenger.start}</span>
                        <div class="input-group-append">
                            <span class="input-group-text" id="basic-addon3" onmouseover="ShowBS(${passenger.end})" onmouseout="HiddenShowBS()">${passenger.end}</span>
                        </div>

                    </div>
                    `
                    PassengersDiv.append(AppendDiv)
                })
            }
            else {
                // Остановка
                bus_stop = bus_stop_markers.find(bus_stop => bus_stop.id == BIDValue)
                bus_stop.passengers.forEach(passenger => {
                    var AppendDiv = `
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon3">${passenger.name}</span>
                        </div>
                        <span class="input-group-text" id="basic-addon3" onmouseover="ShowBS(${passenger.start})" onmouseout="HiddenShowBS()">${passenger.start}</span>
                        <div class="input-group-append">
                            <span class="input-group-text" id="basic-addon3" onmouseover="ShowBS(${passenger.end})" onmouseout="HiddenShowBS()">${passenger.end}</span>
                        </div>

                    </div>
                    `
                    PassengersDiv.append(AppendDiv)
                })
            }
        });
    }


    let ShowBSMarker

    function ShowBS(id) {
        function Change_marker(bus_stop) {
            if (ShowBSMarker) {
                ShowBSMarker.remove()
                ShowBSMarker = null
            }
            let style = {
            radius: 15,
            fillOpacity: 0.5,
            color: 'blue',
            };
            ShowBSMarker = L.circleMarker([bus_stop.lat, bus_stop.lng], style).addTo(map).on('click', HiddenShowBS)
            // ShowBSMarker = L.marker([bus_stop.lat, bus_stop.lng], { opacity: 0.5, draggable: true}).addTo(map).on('click', HiddenShowBS)
        }
        bus_stop = bus_stop_markers.find(bus_stop => bus_stop.id == id)
        if (bus_stop) {
            Change_marker(bus_stop)
        }
        else {
            const csrftoken = getCookie('csrftoken');
            $.ajax({
                url: '{% url "PetriNET:get_bs" %}',
                method: 'get',
                dataType: 'html',
                headers: { 'X-CSRFToken': csrftoken },
                data: {
                    "id": id,
                },
                success: function (response) {
                    response_json = JSON.parse(response)
                    bus_stop = response_json.BusStop
                    bus_stop_markers.push(bus_stop)
                    Change_marker(bus_stop)
                },
                error: function (jqXHR, exception) {
                    console.log(`Ошибка сервера\nСтатус: ${jqXHR.status}\nИсключение: ${exception}`)
                }
            });
        }
    }

    function HiddenShowBS() {
        if (ShowBSMarker) {
            ShowBSMarker.remove()
            ShowBSMarker = null
        }
    }


    // Функция отрисовки таймпоинта
    function setStepAction(step) {
        function bus_stop_marker_html(passengers_count) {
            return `
            <div style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <i class="fa-solid fa-location-dot fa-bounce fa-2xl" style="color: #3187cc;"></i>
            <i class="fa-solid" style="background-color: white; border-radius: 10px; margin-top: 12px;">${passengers_count}</i>
            </div>
            `;
        }
        function bus_marker_html(passengers_count) {
            return `
            <div style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
            <i class="fa-solid fa-bus fa-xl"></i>
            <i class="fa-solid" style="background-color: white; border-radius: 10px; margin-top: 10px;">${passengers_count}</i>
            </div>
            `;
        }
        // Вместо этого хранить последнюю анимацию каждого автобуса в объекте автобуса, время анимации сделать временем до следующего таймпоинта (сколько он будет ехать)
        // Всю имитацию перевести на секунды а не шаги, тогда всё должно быть плавнее и расчётливее
        // Изменить цвет маршрутов
        // Добавить остановкам и автобусам popup с пассажирами внутри
        // Возможно автобусам рядом с кол-вом пассажиров номер маршрута для ясновсти
        // console.log(simulation_data.calculate[step - 1]);
        if (simulation_data.calculate[step - 1][1].Bus.length > 0) {
            for (let bus_i = 0; bus_i < simulation_data.calculate[step - 1][1].Bus.length; bus_i++) {
                const bus_action = simulation_data.calculate[step - 1][1].Bus[bus_i];
                bus = bus_markers.find(bus => bus.bus_id == bus_action.bus_id && bus.route_id == bus_action.route_id)
                if (!bus) {
                    bus = {...bus_action}
                    // Создаем элемент div для нашей иконки
                    var iconElement = document.createElement('div');
                    // Создаем иконку из HTML-элемента
                    iconElement.innerHTML = bus_marker_html(bus.passengers_count)

                    let popup = `
                        <div class="BPassengers">
                            <p>Пассажиры:</p>
                            <input id="BID" type="text" value="${bus.bus_id}" hidden>
                            <input id="BRID" type="text" value="${bus.route_id}" hidden>
                            <div id="Passengers">
                            </div>
                        </div>
                        `

                    var busIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: iconElement.innerHTML,
                        iconSize: [16, 42],
                        iconAnchor: [8, 21] // Точка, которая будет соответствовать координате маркера
                    });
                    bus.marker = L.marker([bus.lat, bus.lng], { alt: "Автобус", icon: busIcon }).bindPopup(popup).on('click', SetDataToBPopup).addTo(map)
                    bus_markers.push(bus)
                }
                else {
                    if (bus_action.passengers_count != bus.passengers_count) {
                        // Поменять пассажиров автобуса
                        bus.passengers = bus_action.passengers
                        bus.passengers_count = bus_action.passengers_count
                        var icon = bus.marker.getIcon()
                        icon.options.html = bus_marker_html(bus.passengers_count)
                        bus.marker.setLatLng([bus.lat, bus.lng])
                        bus.marker.setIcon(icon);
                    }
                    if (bus_action.lat != bus.lat || bus_action.lng != bus.lng) {
                        // Переместить автобус
                        var pos_end = map.latLngToLayerPoint([bus_action.lat, bus_action.lng]);
                        bus.lat = bus_action.lat
                        bus.lng = bus_action.lng
                        var new_animation = new L.PosAnimation()
                        animation_list.push(new_animation)
                        new_animation.once('end',function() {
                            bus.marker.setLatLng([bus.lat, bus.lng]);
                        });
                        new_animation.run(bus.marker._icon, pos_end, 0.3);
                    }
                }
            }
        }
        for (let bus_stop_i = 0; bus_stop_i < simulation_data.calculate[step - 1][1].BusStops.length; bus_stop_i++) {
            const bus_stop_action = simulation_data.calculate[step - 1][1].BusStops[bus_stop_i];
            bus_stop = bus_stop_markers.find(bus_stop => bus_stop.id == bus_stop_action.id)
            if (!bus_stop) {
                bus_stop = {...bus_stop_action}
                // Создаем элемент div для нашей иконки
                var iconElement = document.createElement('div');
                // Создаем иконку из HTML-элемента
                iconElement.innerHTML = bus_stop_marker_html(bus_stop.passengers_count)

                let popup = `
                        <div class="BPassengers">
                            <p>Пассажиры:</p>
                            <input id="BID" type="text" value="${bus_stop.id}" hidden>
                            <div id="Passengers">
                            </div>
                        </div>
                        `

                var bus_stop_icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconElement.innerHTML,
                    iconSize: [16, 42],
                    iconAnchor: [8, 21] // Точка, которая будет соответствовать координате маркера
                    // Возможно стоит сделать чуть правее, чтобы автобус не переграждал
                });
                bus_stop.marker = L.marker([bus_stop.lat, bus_stop.lng], { alt: "Автобус", icon: bus_stop_icon }).bindPopup(popup).on('click', SetDataToBPopup).addTo(map)
                BusStops.addLayer(bus_stop.marker)
                bus_stop_markers.push(bus_stop)
            }
            else {
                if (bus_stop_action.passengers_count != bus_stop.passengers_count) {
                    // Поменять пассажиров остановки
                    bus_stop.passengers = bus_stop_action.passengers
                    bus_stop.passengers_count = bus_stop_action.passengers_count
                    var icon = bus_stop.marker.getIcon()
                    icon.options.html = bus_stop_marker_html(bus_stop.passengers_count)
                    bus_stop.marker.setIcon(icon);
                }
            }
        }
        bus_stop_markers.forEach(bus_stop => {
            if (!simulation_data.calculate[step - 1][1].BusStops.find(bus_stop_in_action => bus_stop.id == bus_stop_in_action.id) && bus_stop.marker) {
                bus_stop.passengers = []
                bus_stop.passengers_count = 0
                var icon = bus_stop.marker.getIcon()
                icon.options.html = bus_stop_marker_html(bus_stop.passengers_count)
                bus_stop.marker.setIcon(icon);
            }
        })
    }

    // Функция для автоматического установления значения в input type="range" и обновления данных симуляции (TODO вынести в отдельную функцию)
    function setRangeValue(step) {
        stop_all_animation()
        setStepAction(step);
        $("#StepsImitation").val(step);
        $("#StepNow").text(step + ' - ' + formatTime(simulation_data.calculate[step - 1][0]));
    }

    // Увеличить шаг на single_step
    function incrRangeValue() {
        step = parseInt($("#StepsImitation").val(), 10);
        maxSteps = parseInt($("#StepsImitation").attr("max"), 10)
        if (step >= maxSteps) {
            stopTimer()
            stop_all_animation()
            return
        }
        step += 1
        setRangeValue(step)
    }

    // Функция работы с step_speed
    function setSingleStep(step_diff) {
        if (step_diff == 0) {
            step_speed = 800
        }
        else {
            step_speed -= step_diff
            step_speed = Math.abs(step_speed);
        }
        $("#SingleStepTitle").text(step_speed + "мс.");
    }

    $("#StepsImitation").on("input", function() {
        setRangeValue($(this).val())
    });

    function Step() {
        incrRangeValue()
    }

    function playTimer() {
        if (timer != null) {
            clearInterval(timer);
        }
        timer = setInterval(Step, step_speed)
    }

    function stopTimer() {
        if (timer != null) {
            clearInterval(timer);
        }
    }

    // Закончить имитацию
    function end_simulation() {
        // Очищаем данные симуляции
        clear_data_for_simulation()
        delete simulation_data
        // Скрыть нижнюю панель
        $("#bottom-panel").addClass("d-none");
        // Показать левую
        $("#left-panel").removeClass("d-none");
        $("#left-panel").addClass("d-flex");
        // Вернуть данные на карту
        UpdateCityData()
        DrawRoutsForCalculate()
    }

    function DownloadReport() {
        if (!simulation_data) {
            alert('Отсутствуют данные для отчёта!')
            return
        }
        const csrftoken = getCookie('csrftoken');
        $.ajax({
            url: '{% url "PetriNET:download_report_file" %}',
            method: 'post',
            dataType: 'html',
            headers: { 'X-CSRFToken': csrftoken },
            data: {
                "data_to_report": JSON.stringify(simulation_data.data_to_report),
            },
            success: function (response) {
                // Создаём временную ссылку для скачивания файла
                const link = document.createElement('a');
                link.href = JSON.parse(response).download_url;
                link.setAttribute('download', ''); // Необходимо для некоторых браузеров
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            error: function (jqXHR, exception) {
                alert(`Ошибка сервера\nСтатус: ${jqXHR.status}\nИсключение: ${exception}`)
            }
        });
    }

    $(document).ready(function() {
        $('.selectpicker').selectpicker();
    });

    ListColor = [
        "#800080", "#FF0000", "#FFFF00", "#008000", "#0000FF", "#9400D3"
    ]
    function arrayRandElement(arr) {
        var rand = Math.floor(Math.random() * arr.length);
        return arr[rand];
    }
</script>
{% endblock %}