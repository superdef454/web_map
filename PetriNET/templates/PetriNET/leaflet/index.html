{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}
{% block js %}
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{{ citys|json_script:"citys_json" }}
{% endblock %}

{% block body %}
<div id="map">
    <div class="left-panel">
        <div class="container-fluid d-flex h-100 justify-content-center align-items-center">
            <div class="row shadow-sm">
                <div class="dropdown mb-3">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Выберите город
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        {% if citys %}
                        {% for city in citys %}
                        <button class="dropdown-item" onclick="ChoiceCity({{city.id}})">{{city.name}}</button>
                        {% endfor %}
                        {% else %}
                        <a class="dropdown-item" href="{% url 'admin:index' %}">Добавить</a>
                        {% endif %}
                    </div>
                </div>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="BusStopName" placeholder="Название остановки"
                        aria-label="Название остановки" aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button id="BusStopAdd" class="btn btn-primary" type="button">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block endjs %}
<script>
    let ActionOnClick = ""
    let LastClickCord = []
    let TempMarker
    let CurrentCity

    var map = L.map('map', { attributionControl: false }).setView([51.7727, 55.0988], 4);
    L.control.attribution({ prefix: 'Маршрутно-транспортные сети' }).addTo(map);

    var lyrOSM = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var lyrEsriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    let BusStops = L.layerGroup().addTo(map);
    let CitysLayer = L.layerGroup().addTo(map);

    let Maps = {
        "OpenStreetMap": lyrOSM,
        "ESRI World Imagery": lyrEsriImagery
    };

    let hide_view_groups = {
        "Города": CitysLayer,
        "Остановки": BusStops,
    }

    L.control.layers(Maps, hide_view_groups, { collapsed: false }).addTo(map);

    let citys = JSON.parse(document.getElementById('citys_json').textContent)
    citys.forEach(city => {
        let city_style = {
            radius: 5,
            fillOpacity: 0.5,
            color: 'black',
        };
        CitysLayer.addLayer(L.circleMarker([city.latitude, city.longitude], city_style)
            .bindPopup(`<a href="#" onclick="ChoiceCity(${city.id})">${city.name}</a>`).on('dblclick', (event) => {
                ChoiceCity(city.id)
            }));
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $("#BusStopAdd").click(function () {
        $(this).attr('style', 'background-color: #007bff; border-color: #007bff;');
        if (CurrentCity) {
            let BusStopName = $("#BusStopName").val()
            if (BusStopName) {
                if (ActionOnClick == 'AddTempMarker' & typeof TempMarker !== "undefined") {
                    $(this).attr('style', 'background-color: #007bff; border-color: #007bff;');
                    $(this).text('+');
                    const csrftoken = getCookie('csrftoken');
                    $.ajax({
                        url: '{% url "PetriNET:ajax_bs_add" %}',
                        method: 'post',
                        dataType: 'html',
                        headers: { 'X-CSRFToken': csrftoken },
                        data: {
                            name: BusStopName,
                            lat: TempMarker.getLatLng().lat,
                            lng: TempMarker.getLatLng().lng,
                            city_id: CurrentCity.id,
                        },
                        success: function (data) {
                            if (JSON.parse(data).error == 0) {
                                BusStops.addLayer(L.marker(TempMarker.getLatLng()).bindPopup(BusStopName));
                                TempMarker.remove();
                                TempMarker = null;
                                ActionOnClick = "";
                                $("#BusStopName").val('')
                            }
                            else {
                                TempMarker.remove();
                                TempMarker = null;
                                ActionOnClick = "";
                                alert("Ошибка добавления остановки\nОтвет сервера: " + data)
                            }
                        },
                        error: function (jqXHR, exception) {
                            TempMarker.remove();
                            TempMarker = null;
                            ActionOnClick = "";
                            alert(`Ошибка сервера\nСтатус: ${jqXHR.status}\nИсключение: ${exception}`)
                        }

                    });
                    return
                };
                if (ActionOnClick == 'AddTempMarker') {
                    $(this).attr('style', 'background-color: #007bff; border-color: #007bff;');
                    $(this).text('+');
                    ActionOnClick = "";
                    return
                }
                $(this).attr('style', 'background-color: #dc3545; border-color: #dc3545;');
                $(this).text('x');
                ActionOnClick = 'AddTempMarker'
            }
            else {
                alert('Введите название остановки!');
            }
        }
        else {
            alert('Выберите город');
        }
    });

    function CancelAddBS() {
        if (TempMarker) {
            TempMarker.remove();
        }
        TempMarker = null;
        ActionOnClick = "";
        $("#BusStopAdd").attr('style', 'background-color: #007bff; border-color: #007bff;');
        $("#BusStopAdd").text('+');
    }

    function ChoiceCity(id) {
        let CityID = id
        let City = citys.find(el => el.id == CityID)
        let CityCircle = CitysLayer.getLayers().find(layer => layer.getLatLng().lat == City.latitude && layer.getLatLng().lng == City.longitude)
        CityCircle.closePopup();
        map.setView([City.latitude, City.longitude], 12);
        if (CurrentCity !== City) {
            CancelAddBS();
            BusStops.clearLayers();
            CurrentCity = City
            $("#dropdownMenuButton").text(City.name)
            const csrftoken = getCookie('csrftoken');
            $.ajax({
                url: '{% url "PetriNET:ajax_bs_get" %}',
                method: 'post',
                dataType: 'html',
                headers: { 'X-CSRFToken': csrftoken },
                data: {
                    city_id: CurrentCity.id,
                },
                success: function (data) {
                    JSON.parse(data).BSList.forEach(BS => {
                        var popupDiv = document.createElement("div");
                        popupDiv.innerHTML = `<a href="{% url 'admin:index' %}PetriNET/busstop/${BS.id}/change/"><p>${BS.name}</p></a>`;
                        BusStops.addLayer(L.marker([BS.latitude, BS.longitude]).bindPopup(popupDiv));
                    });
                }
            });
        }
    }

    map.on('dblclick', (event) => {
        LastClickCord = [event.latlng.lat, event.latlng.lng]
        if (ActionOnClick == 'AddTempMarker') {
            if (TempMarker) {
                TempMarker.remove()
            }
            TempMarker = L.marker(LastClickCord, { opacity: 0.5, draggable: true }).addTo(map).on('click', (event) => {
                TempMarker.remove();
                TempMarker = null;
                $("#BusStopAdd").attr('style', 'background-color: #007bff; border-color: #007bff;');
                $("#BusStopAdd").text('+');
                ActionOnClick = "";
            })
            $("#BusStopAdd").attr('style', '    background-color: #28a745; border-color: #28a745;');
            $("#BusStopAdd").text('✓');
        }
    })
</script>
{% endblock %}