<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ –∏ —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ–∫–Ω–∞ –í—ã–±—Ä–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
function SetChoiceRouteForCalculate() {
    let modal = $("#ChoiceRouteForCalculate")
    let body = modal.find(".modal-body")
    if (body.html().trim() !== '') {}
    else if (Routes.length > 0) {
        body.html(`
        <div class="d-flex justify-content-center flex-wrap bd-highlight">
        `)
        Routes.forEach((route, index) => {
            body.append(`
                <button id="RouteCheckbox${route.id}" type="button" class="btn btn-primary bd-highlight mb-3 mr-3" data-toggle="button" aria-pressed="false"
                onclick="RouteCheck(${route.id});">
                ${index + 1}: ${route.name}
                </button>
            `)
        })
        body.append(`
        </div>
        `)
    }
    else {
        body.html('<p>–ú–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–µ—Ç</p>')
    }
    // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
    DrawRoutsForCalculate()
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –í—ã–±—Ä–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
function RoutesChoose() {
    if (!CityExists()) {
        return
    }
    if (RoutesForCalculate.length > 0) {
        RouteLayer.clearLayers();
        RoutesForCalculate.forEach((route, index) => {
            DrawRoute(route);
        })
    }
    let modal = $("#ChoiceRouteForCalculate")
    let body = modal.find(".modal-body")
    SetChoiceRouteForCalculate()
    modal.modal('show')
}

// –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª / –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
function CreateDataToCalculate() {
    if (!CheckDataToCalculateExists()) {
        return null
    }
    DataToCalculate = {
        "routes": RoutesForCalculate.map(({ id, name }) => ({ id, name })),
        "busstops": BSPassengersDirections,
        "city_id": CurrentCity.id,
    }
    return DataToCalculate
}

// –§—É–Ω–∫—Ü–∏—è –°–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞
function DownloadDataToCalculate() {
    if (!CityExists()) {
        return
    }
    DataToCalculate = CreateDataToCalculate()
    if (DataToCalculate == null) {
        return
    }
    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç—Ä–æ–∫—É JSON
    const dataStr = JSON.stringify(DataToCalculate);
    // –°–æ–∑–¥–∞–Ω–∏–µ Blob –æ–±—ä–µ–∫—Ç–∞ —Å —Ç–∏–ø–æ–º –¥–∞–Ω–Ω—ã—Ö JSON
    const blob = new Blob([dataStr], { type: "application/json" });
    // –°–æ–∑–¥–∞–Ω–∏–µ URL –¥–ª—è Blob –æ–±—ä–µ–∫—Ç–∞
    const url = URL.createObjectURL(blob);

    // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    const link = document.createElement('a');
    Data = new Date();
    Data.setMilliseconds(0)
    link.download = `DataToCalculate_${Data.toLocaleDateString()}_${Data.toLocaleTimeString()}.json`; // –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    link.href = url;
    link.style.display = 'none'; // –°–∫—Ä—ã—Ç–∏–µ —Å—Å—ã–ª–∫–∏

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É –∏ –µ—ë –∞–∫—Ç–∏–≤–∞—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    document.body.appendChild(link);
    link.click();

    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –°–±—Ä–æ—Å
function Reset() {
    // –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤
    let modal = $("#ChoiceRouteForCalculate")
    let body = modal.find(".modal-body")
    body.html('')
    CloseAllAction()
    RoutesForCalculate = []
    BSPassengersDirections = {}
    map.closePopup()
    // –û—á–∏—â–∞–µ–º —Ä–∞–π–æ–Ω—ã
    ClearDistricts()
    ShowAllRoutes()
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –†–∞—Å—á—ë—Ç
function –°alculation() {
    if (!CityExists()) {
        return
    }
    DataToCalculate = CreateDataToCalculate()
    if (DataToCalculate == null) {
        return
    }
    const csrftoken = getCookie('csrftoken');
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –≤ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
    const transformedBusstops = {};
    Object.keys(DataToCalculate.busstops).forEach(busstopId => {
        const oldData = DataToCalculate.busstops[busstopId];
        transformedBusstops[busstopId] = {
            busstop_id: parseInt(busstopId),
            passengers_without_direction: parseInt(oldData.PWD || 0),
            directions: []
        };
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        if (oldData.Directions && typeof oldData.Directions === 'object') {
            Object.values(oldData.Directions).forEach(direction => {
                // –ò—â–µ–º –≤—Å–µ –ø–∞—Ä—ã BusStopIDx –∏ PassengersCountx
                Object.keys(direction).forEach(key => {
                    if (key.startsWith('BusStopID')) {
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1" –∏–∑ "BusStopID1")
                        const directionNumber = key.replace('BusStopID', '');
                        const passengersKey = `PassengersCount${directionNumber}`;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ PassengersCount
                        if (direction[passengersKey]) {
                            transformedBusstops[busstopId].directions.push({
                                busstop_id: parseInt(direction[key]),
                                passengers_count: parseInt(direction[passengersKey])
                            });
                        }
                    }
                });
            });
        }
    });
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
    const newFormatData = {
        data_to_calculate: {
            city_id: DataToCalculate.city_id,
            routes: DataToCalculate.routes,
            busstops: transformedBusstops
        },
        get_timeline: true
    };
    
    $.ajax({
        url: '/api/calculations/calculate/',
        method: 'post',
        contentType: 'application/json',
        headers: { 'X-CSRFToken': csrftoken },
        data: JSON.stringify(newFormatData),
        success: function (data) {
            if (data.error === 0) {
                analysis_of_calculation_result(data)
            } else {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã—Ö —Å –∫–æ–¥–æ–º 200
                showCalculationError(data, 200)
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP –æ—à–∏–±–æ–∫ (400, 500 –∏ —Ç.–¥.)
            let errorData = null;
            try {
                errorData = JSON.parse(jqXHR.responseText);
            } catch (e) {
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
                errorData = {
                    error_message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
                    details: jqXHR.responseText || textStatus,
                    stage: 'unknown'
                };
            }
            showCalculationError(errorData, jqXHR.status)
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫ —Ä–∞—Å—á—ë—Ç–∞
function showCalculationError(errorData, statusCode) {
    let errorMessage = '‚ö†Ô∏è –û–®–ò–ë–ö–ê –†–ê–°–ß–Å–¢–ê\n';
    
    // –°—Ç–∞—Ç—É—Å HTTP
    errorMessage += `üìä HTTP —Å—Ç–∞—Ç—É—Å: ${statusCode}\n`;
    
    // –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (errorData.error_message) {
        errorMessage += `‚ùå ${errorData.error_message}\n`;
    }
    
    // –≠—Ç–∞–ø, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
    if (errorData.stage) {
        const stageNames = {
            'validation': '–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',
            'data_preparation': '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö',
            'petri_net_initialization': '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—á—ë—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏',
            'calculation': '–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞',
            'report_generation': '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞'
        };
        errorMessage += `üîç –≠—Ç–∞–ø –æ—à–∏–±–∫–∏: ${stageNames[errorData.stage] || errorData.stage}\n`;
    }
    
    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é
    if (errorData.hint) {
        errorMessage += `üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:\n${errorData.hint}\n`;
    }
    
    // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    if (errorData.details && typeof errorData.details === 'string') {
        errorMessage += `‚ÑπÔ∏è –î–µ—Ç–∞–ª–∏:\n${errorData.details}`;
    } else if (errorData.details && typeof errorData.details === 'object') {
        errorMessage += `‚ÑπÔ∏è –î–µ—Ç–∞–ª–∏:\n${JSON.stringify(errorData.details, null, 2)}`;
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    alert(errorMessage);
    
    // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    console.error('Calculation Error:', {
        statusCode: statusCode,
        errorData: errorData,
        timestamp: new Date().toISOString()
    });
}

// –†–∞–∑–±–æ—Ä —Ñ–∞–π–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function PetriFileProcess(files) {
    if (files.length > 0) {
        let file = files[0];
        if (file.type == 'application/json') {
            Reset()
            let reader = new FileReader();
            reader.onload = function (e) {
                let DataToCalculate = JSON.parse(e.target.result)
                try {
                    if (DataToCalculate.city_id != CurrentCity.id) {
                        throw `–ù–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω –≥–æ—Ä–æ–¥. –ù—É–∂–Ω–æ: ${DataToCalculate.city_id}, –≤–∞—à: ${CurrentCity.id}`;
                    }
                    BSPassengersDirections = DataToCalculate.busstops
                    RoutesForCalculate = Routes.filter(route =>
                        DataToCalculate.routes.some(rout => rout.id == route.id)
                    );
                    SetChoiceRouteForCalculate()
                    RoutesForCalculate.forEach((route, index) => {
                        $(`#RouteCheckbox${route.id}`).addClass("active").attr('aria-pressed="true"')
                    })
                } catch (e) {
                    Reset()
                    alert(e)
                }
            };
            reader.readAsText(file);
        }
        $("#FilePetri").val(null);
    }
}
</script>
