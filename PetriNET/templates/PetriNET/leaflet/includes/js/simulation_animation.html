<script>
// Функции анимации и отрисовки симуляции

function SetDataToBPopup(BMarker) {
    var BPopup
    var BIDValue
    var BRIDValue
        $(".BPassengers").each(function() {
            var popupContent = $(this)
            BIDValue = popupContent.find("#BID").val();
            BRIDValue = popupContent.find("#BRID").val();
            BPopup = this
        });
    let PassengersDiv = $(BPopup).find('#Passengers')
    PassengersDiv.html('')

    $('#Passengers').each(function() {
        if (BRIDValue) {
            // Автобус
            bus = bus_markers.find(bus => bus.bus_id == BIDValue && bus.route_id == BRIDValue)
            bus.passengers.forEach(passenger => {
                var AppendDiv = `
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">${passenger.name}</span>
                    </div>
                    <span class="input-group-text" id="basic-addon3" onmouseover="ShowBS(${passenger.start})" onmouseout="HiddenShowBS()">${passenger.start}</span>
                    <div class="input-group-append">
                        <span class="input-group-text" id="basic-addon3" onmouseover="ShowBS(${passenger.end})" onmouseout="HiddenShowBS()">${passenger.end}</span>
                    </div>
                </div>
                `
                PassengersDiv.append(AppendDiv)
            })
        }
        else {
            // Остановка
            bus_stop = bus_stop_markers.find(bus_stop => bus_stop.id == BIDValue)
            bus_stop.passengers.forEach(passenger => {
                var AppendDiv = `
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon3">${passenger.name}</span>
                    </div>
                    <span class="input-group-text" id="basic-addon3" onmouseover="ShowBS(${passenger.start})" onmouseout="HiddenShowBS()">${passenger.start}</span>
                    <div class="input-group-append">
                        <span class="input-group-text" id="basic-addon3" onmouseover="ShowBS(${passenger.end})" onmouseout="HiddenShowBS()">${passenger.end}</span>
                    </div>
                </div>
                `
                PassengersDiv.append(AppendDiv)
            })
        }
    });
}

// Функция отрисовки таймпоинта
function setStepAction(step) {
    function bus_stop_marker_html(passengers_count) {
        return `
        <div style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <i class="fa-solid fa-location-dot fa-bounce fa-2xl" style="color: #3187cc;"></i>
        <i class="fa-solid" style="background-color: white; border-radius: 10px; margin-top: 12px;">${passengers_count}</i>
        </div>
        `;
    }
    function bus_marker_html(passengers_count) {
        return `
        <div style="display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <i class="fa-solid fa-bus fa-xl"></i>
        <i class="fa-solid" style="background-color: white; border-radius: 10px; margin-top: 10px;">${passengers_count}</i>
        </div>
        `;
    }
    
    if (simulation_data.calculate[step - 1][1].Bus.length > 0) {
        for (let bus_i = 0; bus_i < simulation_data.calculate[step - 1][1].Bus.length; bus_i++) {
            const bus_action = simulation_data.calculate[step - 1][1].Bus[bus_i];
            bus = bus_markers.find(bus => bus.bus_id == bus_action.bus_id && bus.route_id == bus_action.route_id)
            if (!bus) {
                bus = {...bus_action}
                // Создаем элемент div для нашей иконки
                var iconElement = document.createElement('div');
                // Создаем иконку из HTML-элемента
                iconElement.innerHTML = bus_marker_html(bus.passengers_count)

                let popup = `
                    <div class="BPassengers">
                        <p>Пассажиры:</p>
                        <input id="BID" type="text" value="${bus.bus_id}" hidden>
                        <input id="BRID" type="text" value="${bus.route_id}" hidden>
                        <div id="Passengers">
                        </div>
                    </div>
                    `

                var busIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconElement.innerHTML,
                    iconSize: [16, 42],
                    iconAnchor: [8, 21] // Точка, которая будет соответствовать координате маркера
                });
                bus.marker = L.marker([bus.lat, bus.lng], { alt: "Автобус", icon: busIcon }).bindPopup(popup).on('click', SetDataToBPopup).addTo(map)
                bus_markers.push(bus)
            }
            else {
                if (bus_action.passengers_count != bus.passengers_count) {
                    // Поменять пассажиров автобуса
                    bus.passengers = bus_action.passengers
                    bus.passengers_count = bus_action.passengers_count
                    var icon = bus.marker.getIcon()
                    icon.options.html = bus_marker_html(bus.passengers_count)
                    bus.marker.setLatLng([bus.lat, bus.lng])
                    bus.marker.setIcon(icon);
                }
                if (bus_action.lat != bus.lat || bus_action.lng != bus.lng) {
                    // Переместить автобус
                    var pos_end = map.latLngToLayerPoint([bus_action.lat, bus_action.lng]);
                    bus.lat = bus_action.lat
                    bus.lng = bus_action.lng
                    var new_animation = new L.PosAnimation()
                    animation_list.push(new_animation)
                    new_animation.once('end',function() {
                        bus.marker.setLatLng([bus.lat, bus.lng]);
                    });
                    new_animation.run(bus.marker._icon, pos_end, 0.3);
                }
            }
        }
    }
    for (let bus_stop_i = 0; bus_stop_i < simulation_data.calculate[step - 1][1].BusStops.length; bus_stop_i++) {
        const bus_stop_action = simulation_data.calculate[step - 1][1].BusStops[bus_stop_i];
        bus_stop = bus_stop_markers.find(bus_stop => bus_stop.id == bus_stop_action.id)
        if (!bus_stop) {
            bus_stop = {...bus_stop_action}
            // Создаем элемент div для нашей иконки
            var iconElement = document.createElement('div');
            // Создаем иконку из HTML-элемента
            iconElement.innerHTML = bus_stop_marker_html(bus_stop.passengers_count)

            let popup = `
                    <div class="BPassengers">
                        <p>Пассажиры:</p>
                        <input id="BID" type="text" value="${bus_stop.id}" hidden>
                        <div id="Passengers">
                        </div>
                    </div>
                    `

            var bus_stop_icon = L.divIcon({
                className: 'custom-div-icon',
                html: iconElement.innerHTML,
                iconSize: [16, 42],
                iconAnchor: [8, 21] // Точка, которая будет соответствовать координате маркера
            });
            bus_stop.marker = L.marker([bus_stop.lat, bus_stop.lng], { alt: "Автобус", icon: bus_stop_icon }).bindPopup(popup).on('click', SetDataToBPopup).addTo(map)
            BusStops.addLayer(bus_stop.marker)
            bus_stop_markers.push(bus_stop)
        }
        else {
            if (bus_stop_action.passengers_count != bus_stop.passengers_count) {
                // Поменять пассажиров остановки
                bus_stop.passengers = bus_stop_action.passengers
                bus_stop.passengers_count = bus_stop_action.passengers_count
                var icon = bus_stop.marker.getIcon()
                icon.options.html = bus_stop_marker_html(bus_stop.passengers_count)
                bus_stop.marker.setIcon(icon);
            }
        }
    }
    bus_stop_markers.forEach(bus_stop => {
        if (!simulation_data.calculate[step - 1][1].BusStops.find(bus_stop_in_action => bus_stop.id == bus_stop_in_action.id) && bus_stop.marker) {
            bus_stop.passengers = []
            bus_stop.passengers_count = 0
            var icon = bus_stop.marker.getIcon()
            icon.options.html = bus_stop_marker_html(bus_stop.passengers_count)
            bus_stop.marker.setIcon(icon);
        }
    })
}
</script>
